
**产品需求文档 (PRD) - 股票量化分析指标计算系统 V1.0**

**1. 项目背景与目标**

*   **背景**: 需要构建一个系统，利用股票的日行情数据和分红数据，进行量化分析，以支持投资决策。
*   **核心目标**:
    1.  **价值评估 (偏离率)**: 计算股票价格相对于其历史区间的偏离程度，辅助判断当前价格的高低位。
    2.  **收益评估 (股息率)**: 基于历史分红和当前价格计算股息率，评估股票的派息回报水平。
    3.  **交易策略探索 (兑换关系)**: 研究基于价格变动的股票间兑换关系，寻找增加持股数量的可能性（此部分算法待明确）。

**2. 功能需求**

*   **2.1 偏离率计算**
    *   **定义**: `偏离率 = (当前价格 - 某段期间最低价) / 某段期间最低价`
    *   **计算周期**: 每日重新计算，并更新对应股票的最新偏离率数据。
    *   **输入数据**:
        *   当前价格: 目标股票最新交易日的收盘价 (`close`)。来源：基础数据库 (`stock_data.db`) -> `daily_quotes` 表。
        *   期间最低价: 指定期间内每日收盘价 (`close`) 的最低值。来源：基础数据库 (`stock_data.db`) -> `daily_quotes` 表。
    *   **计算期间**:
        *   8年 (向前追溯 8 \* 365 自然日)
        *   5年 (向前追溯 5 \* 365 自然日)
        *   3年 (向前追溯 3 \* 365 自然日)
        *   1年 (向前追溯 1 \* 365 自然日)
        *   6个月 (向前追溯 180 自然日)
    *   **数据处理**: 若股票上市时间不足指定期间，则基于其实际存在的历史数据计算该期间的最低价。
    *   **输出/存储**:
        *   数据库: 指标数据库 (`stock_index_data.db`)
        *   表名: `deviation_rates` (建议)
        *   结构 (建议):
            *   `ts_code` (TEXT, 主键): 股票代码
            *   `last_update_date` (TEXT): 最新更新日期 (YYYYMMDD)
            *   `deviation_rate_8years` (REAL): 8年偏离率
            *   `deviation_rate_5years` (REAL): 5年偏离率
            *   `deviation_rate_3years` (REAL): 3年偏离率
            *   `deviation_rate_1year` (REAL): 1年偏离率
            *   `deviation_rate_6months` (REAL): 6个月偏离率
        *   更新逻辑: 每日计算后，根据 `ts_code` 更新（`UPDATE` 或 `INSERT OR REPLACE`）对应记录。

*   **2.2 股息率计算**(待细化)
    *   **定义**: `股息率 = 某段期间平均分红 / 当前价格`
    *   **计算周期**: 建议每日（或根据分红数据更新频率）重新计算并更新。
    *   **输入数据**:
        *   当前价格: 目标股票最新交易日的收盘价 (`close`)。来源：基础数据库 (`stock_data.db`) -> `daily_quotes` 表。
        *   分红数据: 需要明确分红数据的来源（例如 Tushare API）及存储方式（建议在基础数据库 `stock_data.db` 中创建 `dividend_history` 表，包含 `ts_code`, 除权日 `end_date`, 税后现金分红 `cash_div_tax` 等字段）。
        *   期间平均分红: 计算指定期间内（按除权日 `end_date` 统计）的年均税后现金分红。
    *   **计算期间**:
        *   8年
        *   5年
        *   3年
        *   当年 (**需要明确定义**: 是指最近一个完整财年，还是过去12个月？)
    *   **输出/存储**:
        *   数据库: 指标数据库 (`stock_index_data.db`)
        *   表名: `dividend_yields` (建议)
        *   结构 (建议):
            *   `ts_code` (TEXT, 主键): 股票代码
            *   `last_update_date` (TEXT): 最新更新日期 (YYYYMMDD)
            *   `dividend_yield_8years` (REAL): 8年平均股息率
            *   `dividend_yield_5years` (REAL): 5年平均股息率
            *   `dividend_yield_3years` (REAL): 3年平均股息率
            *   `dividend_yield_current_year` (REAL): 当年股息率
        *   更新逻辑: 计算后，根据 `ts_code` 更新（`UPDATE` 或 `INSERT OR REPLACE`）对应记录。

*   **2.3 股票兑换策略 (待细化)**
    *   **目标**: 探索基于价格变动，发现不同股票 (`stockCode`) 之间可能存在的直接兑换关系，旨在增加总体持有的股权数量或价值。
    *   **需求**: 此功能处于概念阶段，需要进一步详细设计。需明确：
        *   "可兑换关系" 的数学或逻辑定义。
        *   触发兑换的条件。
        *   如何量化 "增加股权数量"。
        *   所需的具体算法和数据。

**3. 数据源与存储**

*   **基础数据库 (`stock_data.db`)**:
    *   `daily_quotes`: 存储每日行情数据。
    *   `ball_code_data`: 存储股票代码转换及基础信息。
    *   `dividend_history` (建议新增): 存储历史分红数据。
*   **指标数据库 (`stock_index_data.db`)**:
    *   `deviation_rates`: 存储最新的偏离率指标。
    *   `dividend_yields` (建议): 存储最新的股息率指标。

**4. 非功能性需求**

*   **自动化**: 指标计算应能自动执行（例如，每日行情和分红数据更新后）。建议使用独立的计算脚本，并通过 Windows 任务计划程序进行调度。
*   **数据准确性**: 保证源数据的准确性，并妥善处理 API 调用可能出现的错误和限制。
*   **性能**: 考虑数据量增长对计算和查询性能的影响，设计高效的数据库查询和计算逻辑（如使用索引）。
*   **可配置性**: 数据库路径、表名、API 密钥等配置项应易于管理（例如，通过 `.env` 文件）。

**5. 待明确事项**

*   **股息率**: "当年股息" 的精确时间范围定义。
*   **分红数据**: 确认分红数据的获取接口、所需字段、存储表结构及更新策略。
*   **兑换策略**: 对 "股票兑换关系" 进行详细的算法设计和需求定义。
*   **错误处理**: 定义指标计算过程中的错误处理机制和日志记录方案。



        