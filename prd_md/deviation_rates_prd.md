# B端产品/功能需求信息模板 (最终定稿)

**1. 基本信息**

* **项目/功能名称**: 股票偏离率自动计算与管理工具
* **您的角色/部门**: 产品负责人/个人开发者
* **主要联系人**: 8h
* **期望完成时间**: 期望于 2025年5月20日 前完成 (注：根据原定“1周内”及当前日期调整，请您确认或修改具体日期)

**2. 背景与目标**

* **当前面临的问题/挑战**: 个人设计的交易策略（初步验证可行）依赖“偏离率”作为关键的`ts_code`（股票代码）筛选参考指标。目前缺乏高效、自动化的偏离率计算工具，影响策略执行效率和准确性。
* **期望解决的核心问题**: 实现偏离率指标的准确、自动化计算，支持每日批量更新及特定`ts_code`的即时按需计算。
* **业务目标**:
    * 基于`ts_code`（股票代码）的历史日交易数据（来源于`daily_quotes`表），为预设的多个时间维度（8年、5年、3年、1年、6个月）准确计算偏离率。
    * 在每个交易日收盘后，自动对`ball_code_data`表中定义的全量`ts_code`（约5500个）执行偏离率的批量计算，并将结果高效、准确地更新至`deviation_rates`数据库表。
    * 提供按需计算功能，允许用户基于最新的日收盘价数据，对指定的单个或多个`ts_code`，或用户在`my_watchlist`表中定义的股票分组，即时触发偏离率计算并更新结果至`deviation_rates`表。
    * 确保计算生成的偏离率数据（存储于`deviation_rates`表）结构清晰、存储稳定，能够便捷地被其他个人分析工具或脚本调用，以有效支持交易策略的筛选与决策过程。
* **项目价值**: 核心价值在于为个人量化交易策略提供及时、准确的关键指标（偏离率）支持，从而提升策略回测与实盘决策的效率和有效性，并助力个人在证券投资分析领域的技能深化。
* **明确的“不做”范围**:
    * 现阶段不开发任何图形用户界面（GUI），所有操作均通过命令行接口（CLI）完成。
    * 现阶段不做微信小程序等公开渠道的数据分享。
    * 计算和数据存储主要在个人电脑或个人控制的服务器上运行。
    * 不做基于实时（分钟级）市场数据的盘中偏离率计算。所有计算均基于本地存储的日线行情数据（`daily_quotes`表）。

**3. 用户与使用场景**

* **目标用户群体**: 当前阶段核心用户为项目发起人本人。通过数据库中的`my_watchlist`表管理不同策略或用途的`ts_code`列表。系统设计上应考虑一定的可扩展性以支持未来潜在的更多个人投资者，但非当前阶段优化重点。
* **用户数量**: 初期用户为1人（项目发起者本人）。未来可能扩展至千人或万人量级，但当前版本不针对此用户规模进行特定性能优化或功能设计。
* **关键使用场景 (User Stories/Use Cases)**:
    * **场景一：每日批量计算 (Batch Calculation)**
        * **用户**: 系统 (通过定时任务)
        * **触发**: 操作系统定时任务 (如 Windows 任务计划程序或 Linux cron) 在每个交易日收盘后自动触发。
        * **操作**: 执行命令 `python calculate_deviation.py`。
        * **动作**:
            1.  从`stock_data.db`数据库的`ball_code_data`表中获取所有唯一的`ts_code`作为待计算列表（预计约5500个）。
            2.  对每个`ts_code`，从`daily_quotes`表获取其最新的日收盘价及计算所需历史数据。
            3.  按照【4. 核心功能需求 -> 功能细节描述 -> 2.1 偏离率计算】中定义的规则，计算所有预设时间维度的偏离率。
            4.  **失败处理与重试**: 单个`ts_code`计算失败（例如，因源数据不足、期间最低价为零等特定业务异常，或发生其他计算逻辑错误），脚本将立即进行重试，最多额外尝试2次（即总共3次尝试）。重试之间无固定等待间隔。
            5.  **结果存储**: 结果统一存储或更新至`stock_index_data.db`数据库的`deviation_rates`表。
                * **成功**: 更新对应`ts_code`记录的所有偏离率字段、`last_success_date`（设置为当前交易日）、`last_attempt_timestamp`，并将`calculation_status`置为 'Success'。
                * **最终失败** (3次尝试后仍失败): 更新对应`ts_code`记录的`last_attempt_timestamp`，将`calculation_status`置为 'Failed'，记录具体的`failure_reason`，并将该`ts_code`所有维度的偏离率字段更新为 NULL。
        * **验收标准**:
            * 每日批量计算任务能够在预设的10分钟性能目标内完成对约5500个`ts_code`的偏离率计算。
            * 所有成功计算的`ts_code`，其在`deviation_rates`表中的记录均按上述“成功”逻辑正确更新。
            * 所有最终计算失败的`ts_code`，其在`deviation_rates`表中的记录均按上述“最终失败”逻辑正确更新（包括偏离率字段为NULL）。
            * 用户可以通过查询`deviation_rates`表的相关字段有效监控各`ts_code`的计算状态和最新结果。
    * **场景二：失败重算 (Retry Failed Calculations)**
        * **用户**: 我本人
        * **触发**: 手动在命令行执行。
        * **操作**: 执行命令 `python calculate_deviation.py --retry_failed`。
        * **动作**:
            1.  查询`deviation_rates`表，找出所有`calculation_status`为 'Failed' 的`ts_code`列表。
            2.  对列表中的每个`ts_code`，重新执行与【场景一：每日批量计算】中步骤2-5完全相同的获取数据、计算、失败处理与重试、结果存储逻辑。
        * **验收标准**:
            * 脚本能正确识别并仅尝试重新计算`deviation_rates`表中`calculation_status`为 'Failed' 的记录。
            * 重新计算的过程（包括数据获取、计算逻辑、内部3次重试、结果更新）与每日批量计算场景完全一致。
            * 重新计算后，相应`ts_code`在`deviation_rates`表中的状态和数据被正确更新。
    * **场景三：数据核验 (Data Verification)**
        * **用户**: 我本人
        * **触发**: 按需手动进行。
        * **动作**:
            1.  （初期手动）选取至少10个不同特征（如上市时间长短、不同行业、历史价格波动差异大）的`ts_code`。
            2.  将其通过本工具计算出的各维度偏离率结果，与使用电子表格软件（如Excel）通过相同原始数据和计算逻辑手动计算的偏离率进行比对。
            3.  **核验方法说明**: 当前阶段主要依赖手动比对。未来可考虑探索更系统或自动化的数据验证方法，例如将脚本计算结果与特定历史时点的、已知正确的数据快照进行比对，或引入小批量、高频次的自动化抽样检查逻辑。
        * **验收标准**: 对于选定的样本，本工具计算的偏离率结果与参照标准（Excel手动计算）之间的计算逻辑应一致，数值结果在允许的误差范围内（例如，小数点后4位内一致，需根据数据精度确定）。
    * **场景四：按需/自选计算 (Ad-hoc / Watchlist Calculation)**
        * **用户**: 我本人
        * **触发**: 手动在命令行执行。
        * **子场景 4a: 指定代码计算**
            * **操作**: 执行命令 `python calculate_deviation.py --codes <ts_code1>,<ts_code2>,...`
            * **动作**:
                1.  解析命令行中以英文逗号分隔的`ts_code`列表。
                2.  对每个`ts_code`，校验其有效性（例如，是否存在于`ball_code_data`表，以及`daily_quotes`表是否有其行情数据）。无效的`ts_code`将被跳过，并向命令行输出提示信息。
                3.  对有效的`ts_code`，执行与【场景一：每日批量计算】中步骤2-5完全相同的获取数据、计算、失败处理与重试、结果存储逻辑。
            * **验收标准**:
                * 系统能正确解析并仅针对命令行中指定的、且有效的`ts_code`执行偏离率计算。
                * 无效`ts_code`被跳过并有提示。
                * 每个有效`ts_code`的计算（包括3次内部重试）和结果更新逻辑与每日批量计算场景一致。
                * 单个`ts_code`的计算及数据库更新（从命令执行到操作完成）应在5秒内完成（此为性能目标，待单线程基线测试验证）。
        * **子场景 4b: 自选组计算**
            * **操作**: 执行命令 `python calculate_deviation.py --watchlist`
            * **动作**:
                1.  查询`stock_index_data.db`数据库`my_watchlist`表，获取所有分组下的所有唯一`ts_code`列表。
                2.  若列表为空，则向命令行输出提示信息并正常退出。
                3.  对列表中的每个`ts_code`，执行与【场景一：每日批量计算】中步骤2-5完全相同的获取数据、计算、失败处理与重试、结果存储逻辑。
            * **验收标准**:
                * 系统能正确读取并处理`my_watchlist`表中的所有`ts_code`。
                * 空列表能正确处理并提示。
                * 每个`ts_code`的计算（包括3次内部重试）和结果更新逻辑与每日批量计算场景一致。
* **用户当前如何完成这些任务**: 当前通过Excel手动查找历史数据并进行公式计算，过程繁琐、耗时且易出错，无自动化系统支持。

**4. 核心功能需求**

* **必须具备的功能 (Must-have)**:
    * **功能点1：每日全量偏离率计算与更新**
        * 系统能够通过操作系统定时任务触发执行`python calculate_deviation.py`脚本。
        * 脚本将读取`stock_data.db`数据库中`ball_code_data`表定义的全量`ts_code`列表（约5500个）。
        * 对每个`ts_code`，基于其在`daily_quotes`表的日线数据，计算【功能细节描述 -> 2.1 偏离率计算】中定义的多个时间维度的偏离率。
        * 计算过程基于Pandas库进行，初期实现为单线程模式。
        * 单个`ts_code`的计算若发生可恢复错误，将自动进行最多2次额外重试（总计3次尝试），重试间无等待。
        * 计算结果（所有偏离率值或NULL）及计算状态（'Success'或'Failed'，及相关时间戳、失败原因）将被存储或更新至`stock_index_data.db`数据库的`deviation_rates`表。
        * 若批量计算任务执行过程中意外中断（如进程被杀死），下次完整执行任务时，将重新处理所有在`ball_code_data`表中定义的`ts_code`，确保数据的最终一致性（不实现复杂的断点续算）。
    * **功能点2：失败记录手动重算**
        * 提供命令行参数`--retry_failed` (`python calculate_deviation.py --retry_failed`)，允许用户手动触发对`deviation_rates`表中所有`calculation_status`为 'Failed' 的`ts_code`记录进行重新计算。
        * 核心计算逻辑、数据获取、3次内部重试机制、成功/失败状态判断及结果存储逻辑，与功能点1（每日全量计算）中对单个`ts_code`的处理完全一致。
        * 计算结果直接更新`deviation_rates`表，用户需自行查询数据库验证结果。
    * **功能点3: 按需即时偏离率计算**
        * 提供命令行参数，支持用户基于本地最新的日收盘价数据（`daily_quotes`表），对特定`ts_code`或`my_watchlist`表中的`ts_code`进行即时偏离率计算。
        * 核心计算逻辑、数据获取、3次内部重试机制、成功/失败状态判断及结果存储逻辑，与功能点1中对单个`ts_code`的处理完全一致。
        * 计算结果直接更新`deviation_rates`表，用户需自行查询数据库验证结果。
        * 具体命令：
            * `python calculate_deviation.py --codes <ts_code1>,<ts_code2>,...`: 计算通过英文逗号严格分隔的指定`ts_code`列表。脚本在计算前会对`ts_code`的有效性（对照`ball_code_data`表和`daily_quotes`表）进行检查，对于无效的`ts_code`（如不存在于`ball_code_data`或无行情数据），将跳过计算并向命令行输出提示信息。
            * `python calculate_deviation.py --watchlist`: 计算`stock_index_data.db`数据库`my_watchlist`表中定义的所有`ts_code`的偏离率。若`my_watchlist`为空，或其中的`ts_code`无效，将跳过并给出相应提示。
* **期望拥有的功能 (Should-have)**: (暂无)
* **可以有的功能 (Could-have)**: (暂无)
* **功能细节描述**:
    * **2.1 偏离率计算**
        * **定义**: `偏离率 = (当前价格 - 某段期间最低价) / 某段期间最低价`
        * **异常处理 - 期间最低价为0**: 若计算出的‘某段期间最低价’为0或负数，则该股票对应维度的偏离率计算结果应被视为无效。此时，应将该维度的偏离率值在`deviation_rates`表中记录为`NULL`。若因此导致所有或部分维度无法计算，`calculation_status`仍可根据整体情况判断，`failure_reason`应注明具体原因，例如：'Error: Minimum price is zero or invalid for X-year period'。
        * **计算基准日**: 所有偏离率计算均基于每个`ts_code`在`daily_quotes`表中可获得的最新一个交易日（`trade_date`）的收盘价（`close`）作为‘当前价格’。
        * **计算触发周期**: 每日批量计算任务应在每个A股**交易日**收盘后执行（例如，北京时间17:00之后），确保当日的收盘价数据已落库可用。
        * **输入数据**:
            * 当前价格: 对应`ts_code`最新交易日的收盘价 (`close`)，来源于`stock_data.db` -> `daily_quotes`表。
            * 期间最低价: 对应`ts_code`在指定回溯日历日范围内的所有**交易日**的收盘价 (`close`) 的最低值，来源于`stock_data.db` -> `daily_quotes`表。
        * **计算回溯期间 (Time Periods)**: 所有期间均从“计算基准日”的**前一日**开始回溯指定的日历天数，然后在此日历区间内寻找所有交易日数据进行计算。
            * 8年: 向前追溯 8 \* 365 个日历日范围内的交易日数据。
            * 5年: 向前追溯 5 \* 365 个日历日范围内的交易日数据。
            * 3年: 向前追溯 3 \* 365 个日历日范围内的交易日数据。
            * 1年: 向前追溯 1 \* 365 个日历日范围内的交易日数据。
            * 6个月: 向前追溯 180 个日历日范围内的交易日数据。
        * **数据处理 - 上市时间不足**: 若`ts_code`在`daily_quotes`表的历史数据不足以覆盖指定的计算回溯日历日范围，则基于其自上市以来的所有可用历史数据（在该日历日范围内）计算该期间的最低价。
        * **输出/存储 (`deviation_rates` 表)**:
            * 数据库: 指标数据库 (`stock_index_data.db`)
            * 表名: `deviation_rates`
            * 结构:
                * `ts_code` (TEXT, 主键): 股票代码 (来源于 `ball_code_data.ts_code`)
                * `deviation_rate_8years` (REAL): 8年偏离率 (若无法计算或最低价为0，则为 NULL)
                * `deviation_rate_5years` (REAL): 5年偏离率 (NULLable)
                * `deviation_rate_3years` (REAL): 3年偏离率 (NULLable)
                * `deviation_rate_1year` (REAL): 1年偏离率 (NULLable)
                * `deviation_rate_6months` (REAL): 6个月偏离率 (NULLable)
                * `calculation_status` (TEXT): 计算状态 ('Success', 'Failed')
                * `last_attempt_timestamp` (TEXT): 最后尝试计算的时间戳 (格式: 'YYYY-MM-DD HH:MM:SS')
                * `last_success_date` (TEXT): 最后一次成功计算的A股交易日期 (格式: 'YYYYMMDD', 仅在status为Success时更新)
                * `failure_reason` (TEXT): 计算失败时的错误信息摘要 (可选, 仅在status为Failed时记录)
            * **更新逻辑**: 每次对一个`ts_code`的计算尝试完成后（无论成功或失败，包括重试的每次），均更新其`last_attempt_timestamp`。如果所有维度的偏离率均成功计算（即值不为NULL），则更新所有偏离率字段、`last_success_date`，并将`calculation_status`置为'Success'。如果任何一次尝试（包括最终的第3次尝试）后，确定计算失败（例如，所有或关键维度偏离率值为NULL，或发生无法恢复的错误），则将`calculation_status`置为'Failed'，记录`failure_reason`，并将所有偏离率字段更新为NULL。数据库操作应采用`INSERT OR REPLACE`或SQLite的`INSERT ... ON CONFLICT(ts_code) DO UPDATE SET ...`逻辑，确保记录存在即更新，不存在即插入。
    * **2.2 命令行接口 (Command-Line Interface)**:
        * 提供一个Python脚本 (命名为 `calculate_deviation.py`) 支持以下命令行参数：
            * 无参数 (`python calculate_deviation.py`): 执行全量批量计算 (场景一)。
            * `--watchlist`: 执行自选组计算 (场景四b)。
            * `--codes <ts_code1>,<ts_code2>,...`: 执行指定`ts_code`计算 (场景四a)。确保能处理`ts_code`中可能包含的`.SH`或`.SZ`等交易所后缀（如果`ball_code_data`表中的`ts_code`包含这些后缀）。
            * `--retry_failed`: 执行失败重算 (场景二)。
            * `--help` (或 `-h`): 显示所有可用命令、参数及其简要说明和用法示例。
        * **常规输出与错误提示**: 脚本在执行关键步骤（如开始全量计算、开始处理指定代码列表、读取N个`ts_code`、`my_watchlist`为空、参数格式错误、无效`ts_code`跳过、数据库连接失败、单个`ts_code`计算成功/失败摘要、执行完毕等）时，应向标准输出（stdout）打印必要的、人类可读的提示性信息。发生致命错误导致脚本提前终止时，应向标准错误（stderr）输出清晰的错误信息。
        * **脚本退出码**: 脚本执行完毕后，应返回一个整数退出码给操作系统：成功完成所有请求操作时返回0；发生用户输入错误（如无效参数）、配置错误（如数据库无法访问）、或执行过程中出现未处理的致命异常时返回非0值（例如1或具体错误代码）。

**5. 数据需求**

* **需要处理/展示的关键数据**:
    * 输入: `ts_code`列表 (来源于`ball_code_data`表或用户指定), 股票日线行情数据 (`daily_quotes`表中的`ts_code`, `trade_date`, `close`)。
    * 中间: `my_watchlist`表中的`ts_code`列表 (用于自选股计算)。
    * 输出: 计算后的各维度偏离率 (或 NULL), 计算状态信息 (`calculation_status`, `last_attempt_timestamp`, `last_success_date`, `failure_reason`) 存储于`deviation_rates`表。
* **数据来源**:
    * `stock_data.db` -> `ball_code_data`表: 提供全量`ts_code`列表 (主键为`ts_code`)。该表还包含`symbol`, `ball_code`等其他股票代码字段，但本偏离率计算仅使用`ts_code`。
    * `stock_data.db` -> `daily_quotes`表: 提供计算所需的日线交易日期 (`trade_date`) 和收盘价 (`close`)，通过`ts_code`关联。
    * `stock_index_data.db` -> `my_watchlist`表: 提供自选股计算场景所需处理的`ts_code`列表。
    * `stock_index_data.db` -> `deviation_rates`表: 作为失败重算场景的输入（读取状态为'Failed'的`ts_code`），并作为所有计算结果的最终存储目标。
* **数据流转**:
    * 1.  **全量计算**: `ball_code_data` (ts_code列表) + `daily_quotes` (行情数据) -> 计算脚本 -> `deviation_rates`表。
    * 2.  **失败重算**: `deviation_rates` (ts_code列表 where status='Failed') + `daily_quotes` (行情数据) -> 计算脚本 -> `deviation_rates`表。
    * 3.  **指定代码计算**: 用户输入 (ts_code列表) + `daily_quotes` (行情数据) -> 计算脚本 -> `deviation_rates`表。
    * 4.  **自选组计算**: `my_watchlist` (ts_code列表) + `daily_quotes` (行情数据) -> 计算脚本 -> `deviation_rates`表。
* **数据可视化/报表需求**: (无)
* **数据结构/存储**:
    * `deviation_rates`表: 详细结构见【4. 核心功能需求 -> 功能细节描述 -> 2.1 偏离率计算 -> 输出/存储】。
    * `my_watchlist`表结构 (存储于 `stock_index_data.db` 数据库):
        * `group_name` (TEXT): 自选股分组名称。
        * `ts_code` (TEXT): 股票代码 (核心标识符，来源于 `ball_code_data.ts_code`)。
        * `symbol` (TEXT, 可选): 其他股票代码标识 (仅供用户参考，本期不用)。
        * `ball_code` (TEXT, 可选): 其他股票代码标识 (仅供用户参考，本期不用)。
        * `added_timestamp` (TEXT/DATETIME, 可选): 添加时间 (格式: 'YYYY-MM-DD HH:MM:SS')。
        * 主键: (`group_name`, `ts_code`)。
        * 注: `--watchlist`命令仅读取`ts_code`字段进行偏离率计算。
    * `ball_code_data`表结构 (位于 `stock_data.db`，仅用于获取`ts_code`列表，假设核心结构):
        * `ts_code` (TEXT, 主键): 核心股票代码。
        * `symbol` (TEXT, 可选): 股票代码别名1。
        * `ball_code` (TEXT, 可选): 股票代码别名2。
        * (其他可能存在的字段，如股票名称 `name`, 上市日期 `list_date`等，但本项目不依赖这些额外字段进行计算)。

**6. 非功能性需求**

* **性能要求**:
    * **批量计算性能**: 针对`ball_code_data`表中约5500个`ts_code`的全量偏离率计算，应在**10分钟**内完成。初期实现将采用基于Pandas优化的单线程Python脚本作为基线。此基线版本的实际性能表现（能否达到10分钟目标）有待测试验证。若未能达标，后续可能需要评估并引入并发处理（如多进程/多线程，需注意Python GIL对CPU密集型任务的影响，可能优先考虑多进程或异步IO配合外部库）等进一步的性能优化措施。
    * **按需/自选计算响应时间**: 对于通过`--codes`或`--watchlist`参数触发的计算，单个`ts_code`的计算（从命令执行到数据库记录更新完成）应力争在**5秒**内。此响应时间目标同样受初期单线程基线实现的影响，实际性能有待测试验证。
* **安全性要求**: 数据库文件 (`stock_data.db`, `stock_index_data.db`) 存储于个人控制的环境，不涉及网络传输层面的敏感数据加密。用户需自行保障运行环境及数据文件的物理安全和访问控制。
* **易用性要求**: 命令行接口应提供清晰的参数说明 (`--help`)、必要的执行过程反馈信息和易于理解的错误提示。参数设计应符合常规CLI工具习惯。
* **兼容性要求**: 脚本核心逻辑使用Python 3.x (建议使用 Python 3.8 或更高稳定版本) 及Pandas库 (建议使用较新稳定版本)。数据存储初期采用SQLite3。脚本应能在Windows 10及主流Linux发行版（如Ubuntu, CentOS，用于未来云服务器部署）上正确运行，需注意文件路径、编码等跨平台问题。
* **可维护性/扩展性**: 代码应遵循PEP 8编码规范，结构清晰，模块化设计（例如，计算逻辑、数据库操作、命令行解析分离），并包含必要的注释。设计上应考虑到未来可能的数据输出格式扩展（如CSV文件）或计算指标的增加。
* **可访问性**: （不适用，因无UI且为个人工具）
* **数据归档/清除策略**: （暂无明确要求，用户自行管理数据库文件）
* **国际化与本地化**: （不适用，为个人中文环境工具）

**7. 现有系统/流程**

* (无)

**8. 约束与限制**

* **预算范围**: 主要成本为个人时间投入。基础设施依赖现有Windows个人电脑及未来可能使用的经济型腾讯云服务器。
* **技术栈**: Python 3.x (建议3.8+), Pandas, SQLite3。
* **开发资源与经验**: 项目发起人无直接Python及Pandas的深入开发经验，计划主要依赖AI辅助编程工具进行代码生成、理解和调试。这可能对开发效率、代码质量优化和复杂问题排查带来挑战。

**9. 假设与依赖**

* **假设**:
    * A1: `stock_data.db`数据库中的`ball_code_data`表和`daily_quotes`表的数据是准确、完整且会定期（至少每个交易日收盘后）更新的。其更新机制不在本项目范围内。
    * A2: 运行脚本的操作系统环境已正确安装Python (建议3.8+) 及所需的第三方库 (Pandas, sqlite3模块等)。
    * A3: 用户具备执行Python脚本、使用命令行以及管理SQLite数据库文件的基本技能。
    * A4: `ts_code`是股票的稳定唯一主键，在各相关表中引用一致。
* **依赖关系**:
    * D1 (外部数据源): 强依赖`stock_data.db`数据库中的`ball_code_data`表（获取`ts_code`列表）和`daily_quotes`表（获取计算所需的行情数据）。这些数据的质量和可用性直接决定本项目输出的价值。
    * D2 (Python环境): 依赖特定版本的Python解释器及Pandas等库。
    * D3 (操作系统): 依赖操作系统的定时任务功能（如Windows任务计划程序, Linux cron）实现每日自动批量计算。

**10. 风险与挑战**

* **R1: AI辅助开发的代码质量与调试复杂性 (高风险)**
    * **描述**: 完全依赖AI生成代码，可能导致生成的代码存在难以察觉的逻辑缺陷、性能问题或不符合最佳实践。在缺乏足够开发经验的情况下，调试和优化由AI生成的复杂代码可能非常耗时且困难。
    * **缓解策略**:
        * 加强【场景三：数据核验】的严格性和覆盖面，对多个典型和边缘案例进行手动和半自动验证。
        * 要求AI生成代码时提供详尽的注释和逻辑说明。
        * 将复杂功能分解为更小的、可独立验证的模块。
        * 逐步学习Python和Pandas基础，提升对AI生成代码的理解和修改能力。
        * 优先保证逻辑正确性，再逐步优化性能。
* **R2: 性能目标无法达成 (中风险)**
    * **描述**: 初期单线程Pandas实现在处理约5500个`ts_code`时，可能无法在10分钟内完成全量计算。
    * **缓解策略**:
        * 完成功能后立即进行基准性能测试。
        * 学习Pandas代码的性能分析和优化技巧（如向量化操作、避免循环、选择合适数据类型）。
        * 如果单线程优化后仍不达标，则研究并引入多进程并行计算方案（需评估数据同步和错误处理的复杂性）。
* **R3: 数据源问题导致计算错误 (中风险)**
    * **描述**: 若上游`daily_quotes`表数据缺失、错误或延迟更新，将导致偏离率计算不准确或失败。
    * **缓解策略**:
        * 在脚本中增加对输入数据的基本校验（如检查最新交易日期是否合理、价格是否为正数）。
        * 清晰记录因数据问题导致的计算失败原因于`failure_reason`。
        * 虽然数据获取非本项目范围，但建议建立监控上游数据更新状态的习惯。
* **R4: 部署与运维的潜在困难 (低至中风险，取决于云服务器经验)**
    * **描述**: 在云服务器上配置Python环境、依赖库、数据库访问及定时任务可能遇到技术障碍。
    * **缓解策略**:
        * 优先确保在本地Windows环境完整、稳定运行。
        * 充分利用云服务商的文档和社区支持。
        * 考虑使用虚拟环境（如venv, conda）管理依赖，方便迁移。
        * 对于定时任务，先在本地模拟，再迁移至云端。

**11. 成功衡量标准 (Success Metrics)**

* **SM1: 核心功能完整性与正确性**:
    * 所有在【4. 核心功能需求 (Must-have)】中定义的功能点均已按描述实现。
    * 通过【3. 用户与使用场景 -> 场景三：数据核验】的严格验证，对于至少20个不同特征的`ts_code`样本，本工具计算的所有维度偏离率与Excel手动计算结果在约定误差内（如小数点后4位）一致。
* **SM2: 自动化与效率提升**:
    * 每日全量偏离率计算任务能通过操作系统定时任务自动触发并成功执行。
    * 项目发起人确认，使用本工具相比原Excel手动计算方式，在数据准备和偏离率获取方面的效率显著提升（例如，从数小时手动操作缩短至10分钟自动执行）。
* **SM3: 性能基线达标**:
    * 每日对约5500个`ts_code`的全量批量偏离率计算能在10分钟的目标时间内完成（基于单线程基线测试，若实际略有超出但差距不大，且已识别瓶颈并有明确优化计划，也可视为阶段性达标）。
    * 按需计算单个`ts_code`的响应时间基本达到5秒内目标。
* **SM4: 稳定性和可靠性**:
    * 脚本在连续运行一周（或5个交易日）的过程中，未出现因代码逻辑导致的频繁崩溃或计算结果不一致的情况。
    * 失败重算机制能够有效处理之前失败的记录。
    * 计算状态和错误信息能被准确记录在`deviation_rates`表中，便于追踪。
* **SM5: 可用性与用户满意度 (针对核心用户)**:
    * 项目发起人（核心用户）能够顺畅使用所有命令行功能完成预期任务。
    * 命令行输出的提示信息和错误信息清晰、有帮助。

**12. 其他信息**

* (无)